}
fn_extract_element(overall_reviews, "answer_value")
fn_extract_element <- function(my_array, my_item){
my_array[my_item, ][sapply(my_array[my_item, ], is.null)] <- NA
unlist(my_array[my_item, ])
}
fn_extract_element(overall_reviews, "answer_value")
overall_rating <- as.numeric(unlist(overall_reviews["answer_value", ]))
overall_rating <- fn_extract_element(overall_reviews["answer_value", ])
overall_rating <- fn_extract_element(overall_reviews["answer_value", ])
fn_extract_element <- function(my_array, my_item){
my_array[my_item, ][sapply(my_array[my_item, ], is.null)] <- NA
unlist(my_array[my_item, ])
}
fn_extract_element(overall_reviews, "answer_value")
overall_rating <- as.numeric(fn_extract_element(overall_reviews, "answer_value"))
overall_comments <- fn_extract_element(overall_reviews, ["comment", ])
overall_comments <- fn_extract_element(overall_reviews, "comment")
overall_comments
review_date <- as.date(fn_extract_element(overall_reviews, "date_published"), "%B %d, %Y")
review_date <- as.Date(fn_extract_element(overall_reviews, "date_published"), "%B %d, %Y")
review_date
review_date <- as.Date(fn_extract_element(overall_reviews, "date_published"), "%B %d, %Y")
review_date
school_id <- fn_extract_element(overall_reviews,"school_id")
school_id
review_type <- sapply(1:num_reviews, function(x) reviews$reviews[[x]]$user_type)
review_type
topical_reviews <- sapply(1:num_reviews, function(x) reviews$reviews[[x]]$topical_reviews)
topical_reviews
topical_reviews
sapply(1:num_reviews, function(x) reviews$reviews[[x]]$topical_reviews)
sapply(1:num_reviews, function(x) reviews$reviews[[x]]$topical_reviews)[[1]]
reviews$reviews[[1]]
reviews$reviews[[1]]$topical_reviews
s <- 2
school_url <- v_school_urls[s]
#rD <- rsDriver()
rD <- rsDriver(browser = "firefox")
#rD <- rsDriver()
rD <- rsDriver(browser = "firefox")
#Sys.sleep(5)
#remDr$open()
remDr$setWindowSize(width = 1920 / 2, height = 1080)
while (length(remDr$findElements("link text", "More")) != 0) {
print(paste("Found", length(remDr$findElements("link text", "More")), "link(s) to click. Clicking and scrolling!"))
remDr$findElements("link text", "More")[[1]]$clickElement()
remDr$executeScript(paste("scroll(0,", i * 1080, ");"))
Sys.sleep(1)
}
### Navigate to page
remDr$navigate(school_url)
while (length(remDr$findElements("link text", "More")) != 0) {
print(paste("Found", length(remDr$findElements("link text", "More")), "link(s) to click. Clicking and scrolling!"))
remDr$findElements("link text", "More")[[1]]$clickElement()
remDr$executeScript(paste("scroll(0,", i * 1080, ");"))
Sys.sleep(1)
}
remDr$close()
system("taskkill /im java.exe /f", intern=FALSE, ignore.stdout=FALSE)
rm(rD)
rD$server$stop()
rm(rD)
system("taskkill /im java.exe /f", intern=FALSE, ignore.stdout=FALSE)
#rD <- rsDriver()
rD <- rsDriver(browser = "firefox")
#remDr <- remoteDriver(browserName = 'firefox')
remDr <- rD[["client"]]
#Sys.sleep(5)
#remDr$open()
remDr$setWindowSize(width = 1920 / 2, height = 1080)
#city_name <- "santa barbara" # 5 pages
city_name <- "goleta" # 2 pages
city_name <- gsub(" ", "-", city_name)
school_list_url_left <- paste0("https://www.greatschools.org/",
state_name,
"/",
city_name,
"/schools/?page=",
sep = "")
#school_list_url_left <- "https://www.greatschools.org/california/santa-barbara/schools/?page="
school_list_url_right <- "&view=table"
school_list_js_xpath <- "/html/head/script[1]"
school_url_left <- 'https://www.greatschools.org'
v_school_url_right <- df_schools$reviews
v_school_url_right <- gsub("#Reviews", "reviews/", v_school_url_right)
v_school_urls <- paste0(school_url_left, v_school_url_right)
v_school_urls <- setdiff(v_school_urls[df_schools$num_reviews > 0], NA)
#school_url <- 'https://www.greatschools.org/california/santa-barbara/11279-Crane-Country-Day-School/reviews/'
city_name <- gsub(" ", "-", city_name)
school_list_url_left <- paste0("https://www.greatschools.org/",
state_name,
"/",
city_name,
"/schools/?page=",
sep = "")
#school_list_url_left <- "https://www.greatschools.org/california/santa-barbara/schools/?page="
school_list_url_right <- "&view=table"
school_list_js_xpath <- "/html/head/script[1]"
num_pages_to_scrape <- 1 # Check this by visiting the city page
source("scrape_school_lists.R")
num_pages_to_scrape <- 2 # Check this by visiting the city page
source("scrape_school_lists.R")
school_url_left <- 'https://www.greatschools.org'
v_school_url_right <- df_schools$reviews
v_school_url_right <- gsub("#Reviews", "reviews/", v_school_url_right)
v_school_urls <- paste0(school_url_left, v_school_url_right)
v_school_urls <- setdiff(v_school_urls[df_schools$num_reviews > 0], NA)
#school_url <- 'https://www.greatschools.org/california/santa-barbara/11279-Crane-Country-Day-School/reviews/'
school_url <- v_school_urls[s]
school_url
### Navigate to page
remDr$navigate(school_url)
while (length(remDr$findElements("link text", "More")) != 0) {
print(paste("Found", length(remDr$findElements("link text", "More")), "link(s) to click. Clicking and scrolling!"))
remDr$findElements("link text", "More")[[1]]$clickElement()
remDr$executeScript(paste("scroll(0,", i * 1080, ");"))
Sys.sleep(1)
}
webpage <- read_html(remDr$getPageSource()[[1]])
webpage %>%
html_elements(".community-breadcrumbs a") %>%
html_text() -> school_name
webpage %>%
html_elements(xpath = "/html/body/div[5]/div/div/div[2]/section/div[2]/script") %>%
html_text(trim = TRUE) %>%
fromJSON(simplifyVector = FALSE) -> l_reviews
num_reviews <- length(l_reviews$reviews)
num_reviews
overall_reviews <- sapply(1:num_reviews, function(x) l_reviews$reviews[[x]]$five_star_review)
fn_extract_element <- function(my_array, my_item){
my_array[my_item, ][sapply(my_array[my_item, ], is.null)] <- NA
unlist(my_array[my_item, ])
}
overall_rating <- as.numeric(fn_extract_element(overall_reviews, "answer_value"))
overall_comments <- fn_extract_element(overall_reviews, "comment")
review_date <- as.Date(fn_extract_element(overall_reviews, "date_published"), "%B %d, %Y")
school_id <- fn_extract_element(overall_reviews,"school_id")
review_type <- sapply(1:num_reviews, function(x) l_reviews$reviews[[x]]$user_type)
review_type
topical_reviews <- sapply(1:num_reviews, function(x) reviews$reviews[[x]]$topical_reviews)
topical_reviews <- sapply(1:num_reviews, function(x) reviews$reviews[[x]]$topical_reviews)
topical_reviews <- sapply(1:num_reviews, function(x) l_reviews$reviews[[x]]$topical_reviews)
topical_reviews
num_reviews
num_reviews[[1]]
topical_reviews[[1]]
unlist( topical_reviews, recursive = FALSE)
topical_reviews[[1]]
topical_reviews <- sapply(1:num_reviews, function(x) l_reviews$reviews[[x]]$topical_reviews, simplify = TRUE)
topical_reviews
topical_reviews <- sapply(1:num_reviews, function(x) l_reviews$reviews[[x]]$topical_reviews)
topical_reviews
data.frame(t(sapply(topical_reviews,c)))
sapply(topical_reviews,c))
sapply(topical_reviews,c))
sapply(topical_reviews,c)
sapply(topical_reviews,cbind)
unlist(sapply(topical_reviews,cbind), recursive = TRUE)
data.frame(sapply(topical_reviews,cbind))
sapply(topical_reviews,cbind)
topical_reviews
t(topical_reviews)
sapply(t(topical_reviews),cbind)
sapply(t(topical_reviews),cbind)
sapply(t(topical_reviews),rbind)
topical_reviews <- sapply(1:num_reviews, function(x) l_reviews$reviews[[x]]$topical_reviews)
l_reviews$reviews[[x]]$topical_reviews
l_reviews$reviews[[1]]
l_reviews$reviews[[1]]$topical_reviews
l_reviews$reviews[[1]]$topical_reviews$comment
l_reviews$reviews[[1]]$topical_reviews$comments
topical_reviews
topical_reviews[[1]]
topical_reviews[[1]]
data.frame(topical_reviews[[1]])
(topical_reviews[[1]])
(topical_reviews[[1]])$comment
(topical_reviews[[1]])[[1]]
(topical_reviews[[1]])[[2]]
(topical_reviews[[2]])[[2]]
(topical_reviews[[2]])
View(topical_reviews)
View(topical_reviews)
length(topical_reviews)
length(topical_reviews)[[1:4]]
length(topical_reviews)[[-5]]
length(topical_reviews)[-5]
length(topical_reviews)[1:4]
(topical_reviews)[-5]
topical_reviews <- topical_reviews[-length(topical_reviews)]
topical_reviews
sapply(t(topical_reviews),rbind)
sapply(topical_reviews,rbind)
sapply(topical_reviews,cbind)
dat.frame(sapply(topical_reviews,cbind))
data.frame(sapply(topical_reviews,cbind))
topical_reviews
topical_reviews <- sapply(1:num_reviews, function(x) l_reviews$reviews[[x]]$topical_reviews)
topical_reviews
topical_reviews[[length(topical_reviews)==0]]
num_reviews
overall_rating <- as.numeric(fn_extract_element(overall_reviews, "answer_value"))
overall_rating
num_reviews <- length(l_reviews$reviews)
num_reviews
overall_reviews <- sapply(1:num_reviews, function(x) l_reviews$reviews[[x]]$five_star_review)
fn_extract_element <- function(my_array, my_item){
my_array[my_item, ][sapply(my_array[my_item, ], is.null)] <- NA
unlist(my_array[my_item, ])
}
overall_rating <- as.numeric(fn_extract_element(overall_reviews, "answer_value"))
overall_comments <- fn_extract_element(overall_reviews, "comment")
review_date <- as.Date(fn_extract_element(overall_reviews, "date_published"), "%B %d, %Y")
school_id <- fn_extract_element(overall_reviews,"school_id")
review_type <- sapply(1:num_reviews, function(x) l_reviews$reviews[[x]]$user_type)
review_type
webpage <- read_html(remDr$getPageSource()[[1]])
webpage %>%
html_elements(".community-breadcrumbs a") %>%
html_text() -> school_name
webpage %>%
html_elements(xpath = "/html/body/div[5]/div/div/div[2]/section/div[2]/script") %>%
html_text(trim = TRUE) %>%
fromJSON(simplifyVector = FALSE) -> l_reviews
num_reviews <- length(l_reviews$reviews)
num_reviews
l_reviews
overall_reviews <- sapply(1:num_reviews, function(x) l_reviews$reviews[[x]]$five_star_review)
webpage %>%
html_elements(xpath = "/html/body/div[5]/div/div/div[2]/section/div[2]/script") %>%
html_text(trim = TRUE) %>%
fromJSON(simplifyVector = FALSE) -> l_reviews
l_reviews
l_reviews
View(l_reviews)
View(l_reviews)
webpage
remDr$getPageSource()
remDr$getPageSource()
webpage <- read_html(remDr$getPageSource())
webpage <- read_html(remDr$getPageSource()[[1]])
webpage %>%
html_elements(xpath = "/html/body/div[5]/div/div/div[2]/section/div[2]/script") %>%
html_text(trim = TRUE) %>%
fromJSON(simplifyVector = FALSE) -> `l_reviews`
webpage %>%
html_elements(xpath = "/html/body/div[5]/div/div/div[2]/section/div[2]/script") %>%
html_text(trim = TRUE) %>%
fromJSON(simplifyVector = FALSE) -> l_reviews
l_reviews
webpage %>%
html_elements(xpath = "/html/body/div[5]/div/div/div[2]/section/div[2]/script") %>%
html_text(trim = TRUE)
webpage %>%
html_elements(xpath = "/html/body/div[7]/section[2]/div[1]/div/div[2]/div[15]/div/script") %>%
html_text(trim = TRUE) %>%
fromJSON(simplifyVector = FALSE) -> l_reviews
webpage %>%
html_elements(xpath = "/html/body/div[7]/section[2]/div[1]/div/div[2]/div[15]/div/script")
webpage %>%
html_elements(xpath = "div.review-list")
webpage %>%
html_elements("div.review-list")
webpage %>%
html_elements("div.review-item-container")
webpage %>%
html_elements("div.review-item-container") %>%
html_text()
webpage %>%
html_elements("div.review-item-container") %>%
webpage %>%
html_elements(xpath = "/html/body/div[5]/div/div/div[2]/section/div[2]/script") %>%
html_text(trim = TRUE) %>%
fromJSON(simplifyVector = FALSE) -> l_reviews
webpage %>%
html_elements("div.review-item-container") %>%
webpage %>%
html_elements(xpath = "/html/body/div[5]/div/div/div[2]/section/div[2]/script") %>%
html_text(trim = TRUE) %>%
fromJSON(simplifyVector = FALSE) -> l_reviews
webpage %>%
html_elements("div.review-item-container") %>%
print()
webpage %>%
html_elements("div.review-item-container") -> review_container
review_container[[1]]
webpage %>%
html_elements("div.review-item-container") $>$
html_element("div.user-type")
webpage %>%
html_elements("div.review-item-container")%>%
html_element("div.user-type")
webpage %>%
html_elements("div.review-item-container")%>%
html_element("div.user-type") %>%
html_text() -> user_type
user_type
webpage %>%
html_elements("div.review-item-container") %>%
html_element("div.overall_comment")
webpage %>%
html_elements("div.review-item-container")
webpage %>%
html_elements("div.review-item-container") -> review_container
review_container[[1]]
review_container[[1]][2]
review_container[[1]][[2]
]
review_container[[1]]
review_container[[1]] %>% html_text()
review_container[[1]]
webpage %>%
html_elements("div.review-item-container") %>%
html_element("five-star-review")
webpage %>%
html_elements("div.review-item-container")
review_container[[1]]
review_container[[1]]  %>% print()
review_container[[1]]  %>% paste()
review_container%>%
html_element("comment")
review_container[[1]]  %>% paste()
review_container%>%
html_element("div.comment")
review_container%>%
html_element("div.comment") %>%
html_text() -> overall_comments
webpage %>%
html_elements("div.review-item-container") %>%
html_element("div.comment") %>%
html_text() -> overall_comments
overall_comments
review_container %>%
html_text(html_element("div.user-type")) -> user_type
webpage %>%
html_elements("div.review-item-container") -> review_container
review_container %>%
html_text(html_element("div.user-type")) -> user_type
webpage %>%
html_elements("div.review-item-container") -> review_container
webpage %>%
html_elements("div.review-item-container") -> review_container
review_container %>%
)
review_container %>%
html_text(html_element("div.user-type")) -> user_type
webpage %>%
html_elements("div.review-item-container") -> review_container
review_container %>%
html_text(html_element("div.user-type")) -> user_type
review_container %>%
html_element("div.user-type") %>%
html_text() -> user_type
user_type
review_container %>%
html_element("div.comment") %>%
html_text() -> overall_comments
overall_comments
review_container %>%
html_element("div.answer_value") %>%
html_text()
review_container
review_container %>%
html_element("div.comment")
review_container %>%
html_element("div.value")
review_container
review_container %>% paste()
review_container %>%
html_element("div.answer") %>%
as.character() %>%
str_count("filled-star") -> overall_rating
overall_rating
review_container %>%
html_element("div.user-type") %>%
html_text() -> review_type
review_container
review_container %>%
html_element("div.type-and-date") %>%
html_text() %>%
as.Date("%B %d, %Y") -> review_date
webpage %>%
html_elements("div.static-container") %>%
html_element("div.container") %>%
html_element("a") %>%
html_text() -> school_name
school_name
webpage %>%
html_elements(".community-breadcrumbs a") %>%
html_text() -> school_name
review_container %>%
html_element("div.type-and-date") %>%
html_text() %>%
as.Date("%B %d, %Y") -> review_date
review_container %>%
as.character() %>%
str_count('<div class="topic"') -> num_topic_reviews
num_topic_reviews
review_container %>%
as.character() %>%
str_count('<div class="topic"') -> num_topic_reviews
webpage %>%
html_elements("div.user-reviews-container") %>%
as.character() %>%
str_count('<div class="topic"') -> num_topic_reviews
num_topic_reviews
review_container %>%
as.character() %>%
str_count('<div class="topic"') -> num_topic_reviews
num_topic_reviews
review_container %>% paste()
review_container[1] %>% paste()
review_container %>%
html_elements("div.topical-review-detail")
review_container %>%
html_elements("div.topical-review-detail") %>% html_text()
school_name
review_container %>%
html_elements("div.topic")
review_container %>%
html_elements("div.topic")
review_container %>%
html_elements("div.topic") %>%
length() -> num_topic_reviews
num_topic_reviews
review_container %>%
html_elements("div.topic") %>%
html_text() -> topic_labels
topic_labels
review_container %>%
html_elements("div.topical-review-detail") %>%
html_element("div.comment") %>%
html_text() -> topic_comments
topic_comments
review_index <- rep(1:length(num_topic_reviews), times = num_topic_reviews)
fn_extract_topic_comments <- function(my_topic) {
tmp <- rep(NA, times = length(review_date))
tmp[review_index[topic_labels == my_topic]] <- topic_comments[which(topic_labels == my_topic)]
return(tmp)
}
homework_comments <- fn_extract_topic_comments("Homework")
homework_comments
teacher_comments <- fn_extract_topic_comments("Teachers")
source('~/GitHub/greatschools_scraping/scripts/scrape_school_reviews.R', echo=TRUE)
homework_comments <- fn_extract_topic_comments("Homework")
teacher_comments <- fn_extract_topic_comments("Teachers")
character_comments <- fn_extract_topic_comments("Character")
leadership_comments <- fn_extract_topic_comments("Leadership")
bullying_comments <- fn_extract_topic_comments("Bullying")
learning_diffs_comments <- fn_extract_topic_comments("Learning Differences")
learning_diffs_comments
review_container %>%
html_elements("div.topical-item") %>%
html_element("div.topic-details") %>%
html_text() -> topic_rating_label
topic_rating_label
review_container %>%
html_elements("div.topical-item") %>%
html_element("div.topical-average") %>%
html_element("div.numeric") %>%
html_text() %>%
as.numeric() -> topic_rating
topic_rating
review_container %>%
html_elements("div.user-reviews-container") %>%
as.character() %>%
str_count('<div class="topical-item"') -> num_topic_ratings
num_topic_ratings
webpage %>%
html_elements("div.user-reviews-container")
webpage %>%
as.character() %>%
str_count('<div class="topical-item"') -> num_topic_ratings
num_topic_ratings
review_index_ratings <- rep(1:length(num_topic_reviews), times = num_topic_ratings)
fn_extract_topic_rating <- function(my_topic) {
tmp <- rep(NA, times = length(review_date))
tmp[review_index_ratings[grep(my_topic, topic_rating_label)]] <-
topic_rating[grep(my_topic, topic_rating_label)]
return(tmp)
}
homework_rating <- fn_extract_topic_rating("Homework")
teacher_rating <- fn_extract_topic_rating("Teachers")
character_rating <- fn_extract_topic_rating("Character")
leadership_rating <- fn_extract_topic_rating("Leadership")
bullying_rating <- fn_extract_topic_rating("Bullying")
learning_diffs_rating <- fn_extract_topic_rating("Learning Differences")
homework_rating
df_school_review <- data.frame(
school_name,
review_type,
review_date,
overall_rating,
overall_comments,
homework_rating,
teacher_rating,
character_rating,
leadership_rating,
bullying_rating,
learning_diffs_rating,
homework_comments,
teacher_comments,
character_comments,
leadership_comments,
bullying_comments,
learning_diffs_comments
)
remDr$close()
rD$server$stop()
rm(rD)
system("taskkill /im java.exe /f", intern=FALSE, ignore.stdout=FALSE)
